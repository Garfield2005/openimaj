<!DOCTYPE html><html xmlns:d="http://docbook.org/ns/docbook" xmlns:fo="http://www.w3.org/1999/XSL/Format">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   
      <title>Chapter&nbsp;5.&nbsp;SIFT and feature matching</title>
      <link rel="stylesheet" type="text/css" href="css/apache-maven-fluido-1.3.0.min.css">
      <link rel="stylesheet" type="text/css" href="css/stylesheet.css">
      <link rel="stylesheet" type="text/css" href="fonts/fonts.css">
      <meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1">
      <link rel="home" href="index.html" title="The OpenIMAJ Tutorial">
      <link rel="up" href="pt02.html" title="Part&nbsp;II.&nbsp;Image Fundamentals">
      <link rel="prev" href="global-image-features.html" title="Chapter&nbsp;4.&nbsp;Global image features">
      <link rel="next" href="image-datasets.html" title="Chapter&nbsp;6.&nbsp;Image Datasets">
      <meta property="fb:admins" content="286108206">
      <meta property="og:type" content="website">
      <link rel="image_src" href="../images/OpenImaj-sq.png">
      <meta property="og:image" content="http://openimaj.org/images/OpenImaj-sq.png">
      <meta property="og:title" content="OpenIMAJ: Open Intelligent Multimedia Analysis">
      <meta property="og:url" content="http://www.openimaj.org">
      <meta property="og:description" content="OpenIMAJ is an award-winning set of libraries and tools for multimedia content analysis and content generation."><script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script><script type="text/javascript">
	      var _gaq = _gaq || [];
	      _gaq.push(['_setAccount', 'UA-38338744-1']);
	      _gaq.push(['_trackPageview']);

	      (function() {
	        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	      })();
	    </script></head>
   <body class="topBarEnabled">
      <div id="topbar" class="navbar navbar-fixed-top navbar-inverse">
         <div class="navbar-inner">
            <div class="container">
               <div class="nav-collapse"><a class="brand" href="../index.html" title="OpenIMAJ"><img src="images/logo-tiny.png" alt="OpenIMAJ"></a><ul class="nav">
                     <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a><ul class="dropdown-menu">
                           <li><a href="../index.html" title="Introduction">Introduction</a></li>
                           <li><a href="../sponsors.html" title="History &amp; Sponsors">History &amp; Sponsors</a></li>
                           <li><a href="../contact.html" title="Support &amp; Contacts">Support &amp; Contacts</a></li>
                           <li><a href="team.html" title="Team">Team</a></li>
                           <li><a href="http://blogs.ecs.soton.ac.uk/multimedia" title="The Blog">The Blog</a></li>
                           <li><a href="http://www.sf.net/p/openimaj/code" title="Source Code">Source Code</a></li>
                           <li class="dropdown-submenu"><a href="../#related" title="Related Projects">Related Projects</a><ul class="dropdown-menu">
                                 <li><a href="http://www.imageterrier.org/" title="ImageTerrier">ImageTerrier</a></li>
                              </ul>
                           </li>
                        </ul>
                     </li>
                     <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a><ul class="dropdown-menu">
                           <li class="dropdown-submenu"><a href="../#gettingstarted" title="Getting Started">Getting Started</a><ul class="dropdown-menu">
                                 <li><a href="../tutorial-pdf.pdf" title="The Tutorial (PDF)">The Tutorial (PDF)</a></li>
                                 <li><a href="../tutorial/index.html" title="The Tutorial (HTML)">The Tutorial (HTML)</a></li>
                              </ul>
                           </li>
                           <li class="dropdown-submenu"><a href="../#using" title="Using OpenIMAJ">Using OpenIMAJ</a><ul class="dropdown-menu">
                                 <li><a href="../BuildFromSource.html" title="Building OpenIMAJ from Source">Building OpenIMAJ from Source</a></li>
                                 <li><a href="../UseLibrary.html" title="Using OpenIMAJ as a Library">Using OpenIMAJ as a Library</a></li>
                                 <li><a href="../Groovy.html" title="Using OpenIMAJ with Groovy">Using OpenIMAJ with Groovy</a></li>
                                 <li><a href="../tools.html" title="OpenIMAJ commandline tools introduction">OpenIMAJ commandline tools introduction</a></li>
                                 <li><a href="../flickrCrawler.html" title="The FlickrCrawler Tool">The FlickrCrawler Tool</a></li>
                                 <li><a href="../bibliography.html" title="Bibliography">Bibliography</a></li>
                              </ul>
                           </li>
                           <li><a href="../apidocs/index.html" title="API Reference">API Reference</a></li>
                           <li class="dropdown-submenu"><a href="#info" title="Project Information">Project Information</a><ul class="dropdown-menu">
                                 <li><a href="../plugin-management.html" title="Plugin Management">Plugin Management</a></li>
                                 <li><a href="../mail-lists.html" title="Mailing Lists">Mailing Lists</a></li>
                                 <li><a href="../integration.html" title="Continuous Integration">Continuous Integration</a></li>
                                 <li><a href="../license.html" title="Project License">Project License</a></li>
                                 <li><a href="../team-list.html" title="Project Team">Project Team</a></li>
                                 <li><a href="../source-repository.html" title="Source Repository">Source Repository</a></li>
                                 <li><a href="../index.html" title="About">About</a></li>
                                 <li><a href="../issue-tracking.html" title="Issue Tracking">Issue Tracking</a></li>
                                 <li><a href="../project-summary.html" title="Project Summary">Project Summary</a></li>
                                 <li><a href="../plugins.html" title="Project Plugins">Project Plugins</a></li>
                                 <li><a href="../dependency-convergence.html" title="Dependency Convergence">Dependency Convergence</a></li>
                                 <li><a href="../dependencies.html" title="Dependencies">Dependencies</a></li>
                              </ul>
                           </li>
                        </ul>
                     </li>
                     <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a><ul class="dropdown-menu">
                           <li><a href="/openimaj-maven-archetypes/index.html" title="OpenIMAJ Maven Archetypes">OpenIMAJ Maven Archetypes</a></li>
                           <li><a href="/openimaj-core-libs/index.html" title="OpenIMAJ Core Libraries">OpenIMAJ Core Libraries</a></li>
                           <li><a href="/openimaj-image/index.html" title="OpenIMAJ Image Processing Libraries">OpenIMAJ Image Processing Libraries</a></li>
                           <li><a href="/openimaj-video/index.html" title="OpenIMAJ Video Processing Libraries">OpenIMAJ Video Processing Libraries</a></li>
                           <li><a href="/openimaj-audio/index.html" title="OpenIMAJ Audio Processing Libraries">OpenIMAJ Audio Processing Libraries</a></li>
                           <li><a href="/openimaj-machine-learning/index.html" title="OpenIMAJ Machine Learning Subprojects">OpenIMAJ Machine Learning Subprojects</a></li>
                           <li><a href="/openimaj-text/index.html" title="OpenIMAJ Text Analysis Subprojects">OpenIMAJ Text Analysis Subprojects</a></li>
                           <li><a href="/thirdparty/index.html" title="OpenIMAJ Third Party Ported Libraries">OpenIMAJ Third Party Ported Libraries</a></li>
                           <li><a href="/openimaj-demos/index.html" title="OpenIMAJ Demos Subproject">OpenIMAJ Demos Subproject</a></li>
                           <li><a href="/openimaj-knowledge/index.html" title="OpenIMAJ Knowledge Representation and Reasoning Libraries">OpenIMAJ Knowledge Representation and Reasoning Libraries</a></li>
                           <li><a href="/test-resources/index.html" title="OpenIMAJ Unit Test Resources">OpenIMAJ Unit Test Resources</a></li>
                           <li><a href="/openimaj-tools/index.html" title="OpenIMAJ Tools">OpenIMAJ Tools</a></li>
                           <li><a href="/openimaj-hadoop/index.html" title="OpenIMAJ Hadoop Subproject">OpenIMAJ Hadoop Subproject</a></li>
                           <li><a href="/openimaj-storm/index.html" title="OpenIMAJ Storm Subproject">OpenIMAJ Storm Subproject</a></li>
                           <li><a href="/openimaj-web/index.html" title="OpenIMAJ web subproject">OpenIMAJ web subproject</a></li>
                           <li><a href="/openimaj-hardware/index.html" title="OpenIMAJ Hardware Subprojects">OpenIMAJ Hardware Subprojects</a></li>
                           <li><a href="/openimaj-content-libs/index.html" title="OpenIMAJ Content Creation Libraries">OpenIMAJ Content Creation Libraries</a></li>
                           <li><a href="/openimaj-ide-integration/index.html" title="OpenIMAJ IDE Integration Plugins">OpenIMAJ IDE Integration Plugins</a></li>
                           <li><a href="/openimaj-documentation/index.html" title="OpenIMAJ Documentation">OpenIMAJ Documentation</a></li>
                        </ul>
                     </li>
                  </ul>
                  <form id="search-form" action="http://www.google.com/search" method="get" class="navbar-search pull-right" name="search-form"><input value="" name="sitesearch" type="hidden"><input class="search-query" name="q" id="query" type="text"></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script><iframe src="http://www.facebook.com/plugins/like.php?href=http://www.openimaj.org/&amp;send=false&amp;layout=button_count&amp;show-faces=false&amp;action=like&amp;colorscheme=dark" scrolling="no" frameborder="0" style="border:none; width:80px; height:20px; margin-top: 10px;" class="pull-right"></iframe><script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script><ul class="nav pull-right">
                     <li style="margin-top: 10px;">
                        <div class="g-plusone" data-href="http://www.openimaj.org/" data-size="medium" width="60px" align="right"></div>
                     </li>
                  </ul>
               </div>
            </div>
         </div>
      </div>
      <div class="container">
         <div id="banner">
            <div class="pull-left">
               <div id="bannerLeft">
                  <h2>OpenIMAJ</h2>
               </div>
            </div>
            <div class="pull-right"></div>
            <div class="clear">
               <hr>
            </div>
         </div>
         <div id="breadcrumbs">
            <ul class="breadcrumb">
               <li id="publishDate" class="pull-right">Last Published: 2015-02-25</li>
               <li class="divider pull-right">|</li>
               <li id="projectVersion" class="pull-right">Version: 1.4-SNAPSHOT</li>
            </ul>
         </div>
         <div id="nav-sub-block"><a class="hide" name="nav-sub-a"></a><ul id="nav-sub">
               <li class="first"><a accesskey="p" href="global-image-features.html"><span>Prev : Global image features</span></a></li>
               <li><a accesskey="h" href="index.html"><span>Contents</span></a></li>
               <li class="last"><a accesskey="n" href="image-datasets.html"><span>Next : Image Datasets</span></a></li>
            </ul>
         </div>
         <div class="chapter" title="Chapter&nbsp;5.&nbsp;SIFT and feature matching">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title"><a name="sift-and-feature-matching"></a>Chapter&nbsp;5.&nbsp;SIFT and feature matching
                     </h2>
                  </div>
               </div>
            </div>
              
              
            <p>
                   In this tutorial we&#8217;ll look at how to compare images to each other.
                   Specifically, we&#8217;ll use a popular <span class="strong"><strong>local
                         feature descriptor</strong></span> called
                   <span class="strong"><strong>SIFT</strong></span> to extract some
                   <span class="emphasis"><em>interesting points</em></span> from images and describe
                   them in a standard way. Once we have these local features and their
                   descriptions, we can match local features to each other and
                   therefore compare images to each other, or find a visual query image
                   within a target image, as we will do in this tutorial.
                 
            </p>
              
            <p>
                   Firstly, lets load up a couple of images. Here we have a magazine
                   and a scene containing the magazine:
                 
            </p>
              <pre class="programlisting">MBFImage query = ImageUtilities.readMBF(new URL("http://static.openimaj.org/media/tutorial/query.jpg"));
MBFImage target = ImageUtilities.readMBF(new URL("http://static.openimaj.org/media/tutorial/target.jpg"));</pre>
            
            <p class="centered">
               	<span class="inlinemediaobject"><img src="figs/query.jpg" align="middle" width="177.16535433070868"></span>
               
               	<span class="inlinemediaobject"><img src="figs/target.jpg" align="middle" width="177.16535433070868"></span>
               
            </p>
            
              
            <p>
                   The first step is feature extraction. We&#8217;ll use the
                   <span class="strong"><strong>difference-of-Gaussian</strong></span> feature
                   detector which we describe with a <span class="strong"><strong>SIFT
                         descriptor</strong></span>. The features we find are described in a way
                   which makes them invariant to size changes, rotation and position.
                   These are quite powerful features and are used in a variety of
                   tasks. The standard implementation of SIFT in OpenIMAJ can be found
                   in the <code class="code">DoGSIFTEngine</code> class:
                 
            </p>
              <pre class="programlisting">DoGSIFTEngine engine = new DoGSIFTEngine();	
LocalFeatureList&lt;Keypoint&gt; queryKeypoints = engine.findFeatures(query.flatten());
LocalFeatureList&lt;Keypoint&gt; targetKeypoints = engine.findFeatures(target.flatten());</pre>
              <p>
                   Once the engine is constructed, we can use it to extract
                   <code class="code">Keypoint</code> objects from our images. The
                   <code class="code">Keypoint</code> class contain a public field called
                   <code class="code">ivec</code> which, in the case of a standard SIFT
                   descriptor is a 128 dimensional description of a patch of pixels
                   around a detected point. Various distance measures can be used to
                   compare <code class="code">Keypoint</code>s to
                   <code class="code">Keypoint</code>s.
                 
            </p>
              
            <p>
                   The challenge in comparing <code class="code">Keypoint</code>s is trying to
                   figure out which <code class="code">Keypoint</code>s match between
                   <code class="code">Keypoint</code>s from some query image and those from
                   some target. The most basic approach is to take a given
                   <code class="code">Keypoint</code> in the query and find the
                   <code class="code">Keypoint</code> that is closest in the target. A minor
                   improvement on top of this is to disregard those points which match
                   well with MANY other points in the target. Such point are considered
                   non-descriptive. Matching can be achieved in OpenIMAJ using the
                   <code class="code">BasicMatcher</code>. Next we&#8217;ll construct and setup such
                   a matcher:
                 
            </p>
              <pre class="programlisting">LocalFeatureMatcher&lt;Keypoint&gt; matcher = new BasicMatcher&lt;Keypoint&gt;(80);
matcher.setModelFeatures(queryKeypoints);
matcher.findMatches(targetKeypoints);</pre>
              <p>
                   We can now draw the matches between these two images found with this
                   basic matcher using the <code class="code">MatchingUtilities</code> class:
                 
            </p>
              <pre class="programlisting">MBFImage basicMatches = MatchingUtilities.drawMatches(query, target, matcher.getMatches(), RGBColour.RED);
DisplayUtilities.display(basicMatches);</pre>
            <div class="mediaobject" align="center"><img src="figs/matches.png" align="middle" width="177.16535433070868"></div>
              
            <p>
                   As you can see, the basic matcher finds many matches, many of which
                   are clearly incorrect. A more advanced approach is to filter the
                   matches based on a given geometric model. One way of achieving this
                   in OpenIMAJ is to use a
                   <code class="code">ConsistentLocalFeatureMatcher</code> which given an
                   internal matcher and a model fitter configured to fit a geometric model, finds which
                   matches given by the internal matcher are consistent with respect to
                   the model and are therefore likely to be correct.
                 
            </p>
              
            <p>
                   To demonstrate this, we&#8217;ll use an algorithm called Random Sample
                   Consensus (RANSAC) to fit a geometric model called an
                   <span class="strong"><strong>Affine transform</strong></span> to the initial
                   set of matches. This is achieved by iteratively selecting a random
                   set of matches, learning a model from this random set and then
                   testing the remaining matches against the learnt model.
                 
            </p>
            
            <div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;">
               <table border="0" summary="Tip">
                  <tr>
                     <td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td>
                     <th align="left">Tip</th>
                  </tr>
                  <tr>
                     <td align="left" valign="top">An Affine transform models the transformation between two parallelograms.</td>
                  </tr>
               </table>
            </div>
              
            <p>
                   We&#8217;ll now set up a RANSAC model fitter configured to find Affine Transforms (using the <code class="code">RobustAffineTransformEstimator</code> helper class) and our consistent matcher:
                 
            </p>
              <pre class="programlisting">RobustAffineTransformEstimator modelFitter = new RobustAffineTransformEstimator(5.0, 1500,
  new RANSAC.PercentageInliersStoppingCondition(0.5));
matcher = new ConsistentLocalFeatureMatcher2d&lt;Keypoint&gt;(
  new FastBasicKeypointMatcher&lt;Keypoint&gt;(8), modelFitter);

matcher.setModelFeatures(queryKeypoints);
matcher.findMatches(targetKeypoints);

MBFImage consistentMatches = MatchingUtilities.drawMatches(query, target, matcher.getMatches(), 
  RGBColour.RED);

DisplayUtilities.display(consistentMatches);</pre>
            <div class="mediaobject" align="center"><img src="figs/matches-affine.png" align="middle" width="177.16535433070868"></div>
              
            <p>
                   The <code class="code">AffineTransformModel</code> class models a
                   two-dimensional Affine transform in OpenIMAJ. The <code class="code">RobustAffineTransformEstimator</code> 
                   class provides a method <code class="code">getModel()</code> which returns the internal Affine Transform model 
                   whose parameters are optimised during the fitting process driven by the <code class="code">ConsistentLocalFeatureMatcher2d</code>.
                   An interesting byproduct of using the <code class="code">ConsistentLocalFeatureMatcher2d</code> is that the
                   <code class="code">AffineTransformModel</code> returned by <code class="code">getModel()</code> contains the best transform
                   matrix to go from the query to the target. We can take advantage of
                   this by transforming the bounding box of our query with the
                   transform estimated in the <code class="code">AffineTransformModel</code>,
                   therefore we can draw a polygon around the estimated location of the
                   query within the target:
                 
            </p>
              <pre class="programlisting">target.drawShape(
  query.getBounds().transform(modelFitter.getModel().getTransform().inverse()), 3,RGBColour.BLUE);
DisplayUtilities.display(target); </pre>
            <div class="mediaobject" align="center"><img src="figs/fittedmodel.png" align="middle" width="177.16535433070868"></div>
              
            <div class="sect1" title="5.1.&nbsp;Exercises">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title" style="clear: both"><a name="exercises-6"></a>5.1.&nbsp;Exercises
                        </h2>
                     </div>
                  </div>
               </div>
                   
                   
               <div class="sect2" title="5.1.1.&nbsp;Exercise 1: Different matchers">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="exercise-1-different-matchers"></a>5.1.1.&nbsp;Exercise 1: Different matchers
                           </h3>
                        </div>
                     </div>
                  </div>
                        
                        
                  <p>
                             Experiment with different matchers; try the
                             <code class="code">BasicTwoWayMatcher</code> for example.
                           
                  </p>
                      
               </div>
                   
               <div class="sect2" title="5.1.2.&nbsp;Exercise 2: Different models">
                  <div class="titlepage">
                     <div>
                        <div>
                           <h3 class="title"><a name="exercise-2-different-models"></a>5.1.2.&nbsp;Exercise 2: Different models
                           </h3>
                        </div>
                     </div>
                  </div>
                        
                        
                  <p>
                             Experiment with different models (such as a
                             <code class="code">HomographyModel</code>) in the consistent matcher. The <code class="code">RobustHomographyEstimator</code> helper class can be used 
                             to construct an object that fits the <code class="code">HomographyModel</code> model. You can also experiment with an alternative robust fitting algorithm to RANSAC called Least Median of Squares (LMedS)
                     through the <code class="code">RobustHomographyEstimator</code>.
                           
                  </p>
                  			
                  <div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;">
                     <table border="0" summary="Tip">
                        <tr>
                           <td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td>
                           <th align="left">Tip</th>
                        </tr>
                        <tr>
                           <td align="left" valign="top">A HomographyModel models a planar Homography between two planes. Planar Homographies are more general than Affine transforms
                              and map quadrilaterals to quadrilaterals.
                           </td>
                        </tr>
                     </table>
                  </div>
                      
               </div>
                 
            </div>
            
         </div>
      </div>
      <div id="nav-sub-block" class="bottom"><a class="hide" name="nav-sub-a"></a><ul id="nav-sub">
            <li class="first"><a accesskey="p" href="global-image-features.html"><span>Prev : Global image features</span></a></li>
            <li><a accesskey="h" href="index.html"><span>Contents</span></a></li>
            <li class="last"><a accesskey="n" href="image-datasets.html"><span>Next : Image Datasets</span></a></li>
         </ul>
      </div>
      <footer>
         <div class="container">
            <div class="row span12">Copyright &copy; 2011-2014 <a href="http://www.soton.ac.uk">The University of Southampton</a>. All Rights Reserved.
                 				
            </div>
            <p id="poweredBy" class="pull-right"><a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png"></a></p>
            <div id="ohloh" class="pull-right"><script type="text/javascript" src="http://www.ohloh.net/p/openimaj/widgets/project_partner_badge.js"></script></div>
         </div>
      </footer>
   </body>
</html>